name: Branch Protection

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install commitlint
        run: npm install --save-dev @commitlint/cli @commitlint/config-conventional

      - name: Validate commit messages
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
        if: github.event_name == 'pull_request'
        continue-on-error: false

  check-secrets:
    name: Check for Leaked Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified
        continue-on-error: false

  check-env-files:
    name: Check for .env Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for .env files
        run: |
          if find . -name ".env" -not -path "./node_modules/*" | grep -q .; then
            echo "::error::Found .env file(s) that should not be committed!"
            find . -name ".env" -not -path "./node_modules/*"
            exit 1
          fi
          echo "No .env files found"

  check-pr-description:
    name: Check PR Description
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    steps:
      - name: Validate PR body
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if [ -z "$PR_BODY" ]; then
            echo "::error::PR description is required"
            exit 1
          fi
          LENGTH=${#PR_BODY}
          if [ "$LENGTH" -lt 20 ]; then
            echo "::error::PR description must be at least 20 characters (got: $LENGTH)"
            exit 1
          fi
          echo "âœ“ PR description is valid ($LENGTH characters)"

  label-pr:
    name: Auto Label PR
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    steps:
      - name: Label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
        continue-on-error: true
